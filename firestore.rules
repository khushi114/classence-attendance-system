rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════
    // Helper functions
    // ═══════════════════════════════════════════

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isFaculty() {
      return isAuthenticated() && getUserRole() == 'faculty';
    }

    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ═══════════════════════════════════════════
    // USERS COLLECTION
    // ═══════════════════════════════════════════

    match /users/{userId} {
      // Owner can always read/update their own profile (no role check needed!)
      // Faculty/Admin can read other users (uses role check on THEIR doc, not the target)
      allow read: if isOwner(userId)
                  || (isAuthenticated() && getUserRole() == 'faculty')
                  || (isAuthenticated() && getUserRole() == 'admin');

      // Users can create their own profile during registration
      allow create: if isOwner(userId);

      // Users can update their own profile (e.g., face embedding)
      // Admin can update any user
      allow update: if isOwner(userId)
                    || (isAuthenticated() && getUserRole() == 'admin');

      // Only admin can delete users
      allow delete: if isAuthenticated() && getUserRole() == 'admin';
    }

    // ═══════════════════════════════════════════
    // CLASSES COLLECTION
    // ═══════════════════════════════════════════

    match /classes/{classId} {
      // Students can read classes they're enrolled in
      // Faculty can read their own classes
      // Admin can read all
      allow read: if isAuthenticated();

      // Faculty can create classes (they must be the facultyId)
      // Admin can create any class
      allow create: if (isFaculty() && request.resource.data.facultyId == request.auth.uid)
                    || isAdmin();

      // Faculty can update their own classes
      // Admin can update any class
      allow update: if isAuthenticated(); // DEBUG: Relaxed for testing
                    // if (isFaculty() && resource.data.facultyId == request.auth.uid)
                    // || isAdmin();

      // Only admin can delete classes
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════
    // SESSIONS COLLECTION
    // ═══════════════════════════════════════════

    match /sessions/{sessionId} {
      // Authenticated users can read sessions (students need to verify token)
      allow read: if isAuthenticated();

      // Faculty can create sessions for their own classes
      allow create: if isFaculty()
                    && request.resource.data.facultyId == request.auth.uid;

      // Faculty can update (end) their own sessions
      // Admin can update any session
      allow update: if (isFaculty() && resource.data.facultyId == request.auth.uid)
                    || isAdmin();

      // Only admin can delete sessions
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════
    // ATTENDANCE COLLECTION
    // ═══════════════════════════════════════════

    match /attendance/{recordId} {
      // Students can read their own attendance
      // Faculty can read attendance for sessions they created
      // Admin can read all
      allow read: if isOwner(resource.data.studentId)
                  || isFaculty()
                  || isAdmin();

      // Students can only write their OWN attendance
      // Must have all verification flags set to true
      allow create: if isStudent()
                    && request.resource.data.studentId == request.auth.uid
                    && request.resource.data.bluetoothVerified == true
                    && request.resource.data.geoVerified == true
                    && request.resource.data.faceVerified == true
                    && request.resource.data.livenessVerified == true
                    && request.resource.data.confidenceScore is number
                    && request.resource.data.confidenceScore >= 0.0;

      // No one can update attendance records (immutable audit trail)
      allow update: if false;

      // Only admin can delete attendance records
      allow delete: if isAdmin();
    }
    // ═══════════════════════════════════════════
    // TIMETABLES COLLECTION
    // ═══════════════════════════════════════════

    match /timetables/{classId} {
      // Authenticated users can read timetables
      allow read: if isAuthenticated();

      // Allow any authenticated user to write (DEBUG)
      allow write: if isAuthenticated(); 
    }
  }
}
